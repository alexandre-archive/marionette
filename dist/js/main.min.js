function HandPosition(n,e,t){this.x=n,this.y=e,this.z=t}function c(n,e,t){var o=e,i=0,r=e/(t||2),a=e/-(t||2),s=o-i,c=r-a;return(n-i)*c/s+a}function SetupException(n){this.message=n,this.name="SetupException"}function MarionetteDrawer(){function n(n){g=n,T={},R={},v=new THREE.Scene,M=window.innerWidth,b=window.innerHeight;var e=75,t=M/b,o=.1,i=1e3;w=new THREE.PerspectiveCamera(e,t,o,i),v.add(w),w.position.y=0,w.position.x=0,w.position.z=400,w.target=new THREE.Vector3(0,150,0),w.lookAt(v.position),H=new THREE.WebGLRenderer({antialias:!0}),H.setClearColor(15790320),H.setPixelRatio(window.devicePixelRatio),H.setSize(M,b),g.appendChild(H.domElement);var r=new THREE.DirectionalLight(15724543,2);r.position.set(1,1,1).normalize(),v.add(r);var r=new THREE.DirectionalLight(16773103,2);r.position.set(-1,-1,-1).normalize(),v.add(r),f(),window.addEventListener("resize",m,!1)}function e(n){if(n in T){var e=T[n];v.remove(e)}}function t(n){var e=[];e.push(new THREE.MeshBasicMaterial({color:16724787})),e.push(new THREE.MeshBasicMaterial({color:16746496})),e.push(new THREE.MeshBasicMaterial({color:16777011})),e.push(new THREE.MeshBasicMaterial({color:3407667})),e.push(new THREE.MeshBasicMaterial({color:3355647})),e.push(new THREE.MeshBasicMaterial({color:8926207}));var t=new THREE.MeshFaceMaterial(e),o=new THREE.CubeGeometry(100,100,100,1,1,1);cube=new THREE.Mesh(o,t),cube.position.set(0,0,0),v.add(cube),T[n]=cube}function o(){var n=new THREE.ImageUtils.loadTexture("images/country.png"),e=new THREE.MeshBasicMaterial({map:n,side:THREE.DoubleSide}),t=new THREE.PlaneGeometry(2*M,2*b,10,10),o=new THREE.Mesh(t,e);o.position.z=-400,v.add(o)}function i(n){var e=new THREE.JSONLoader(!0);e.load("models//horse.json",function(e){var t=new THREE.Mesh(e,new THREE.MeshLambertMaterial({color:6316128,morphTargets:!0}));t.scale.set(.8,.8,.8),v.add(t),T[n]=t;var o=new THREE.MorphAnimation(t);o.play(),R[n]=o})}function r(n){var e=new THREE.JSONLoader;e.load("models/flamingo.json",function(e){a(e),e.computeMorphNormals();var t=new THREE.MeshLambertMaterial({color:16777215,morphTargets:!0,morphNormals:!0,vertexColors:THREE.FaceColors,shading:THREE.FlatShading}),o=new THREE.MorphAnimMesh(e,t);o.duration=5e3,o.scale.set(1,1,1),o.position.y=200,v.add(o),T[n]=o,R[n]=o,o.position.setY(240)})}function a(n){if(n.morphColors&&n.morphColors.length)for(var e=n.morphColors[0],t=0;t<e.colors.length;t++)n.faces[t].color=e.colors[t],n.faces[t].color.offsetHSL(0,.3,0)}function s(n,e,t,o){if(n in T){var i=T[n];i.position.setX(e),i.position.setY(t),i.position.setZ(o)}}function c(n,e){if(n in T){var t=T[n],o=new THREE.Matrix4;o.makeRotationX(u(e)),t.applyMatrix(o)}}function d(n,e){if(n in T){var t=T[n],o=new THREE.Matrix4;o.makeRotationY(u(e)),t.applyMatrix(o)}}function u(n){return n*Math.PI/180}function h(){requestAnimationFrame(h),l(),_.update()}function l(){if(R&&!j){var n=Date.now();for(obj in R)R[obj].update?R[obj].update(n-L):R[obj].updateAnimation(n-L);L=n}H.clear(),H.setViewport(0,0,M,b),H.render(v,w)}function f(){return _=new Stats,_.setMode(0),_.domElement.style.position="absolute",_.domElement.style.left="0px",_.domElement.style.top="0px",g.appendChild(_.domElement),_}function m(n){M=window.innerWidth,b=window.innerHeight,H.setSize(M,b),w.aspect=.5*M/b,w.updateProjectionMatrix()}function p(){j=!0}function E(){j=!1}this.init=n,this.addCube=t,this.animate=h,this.moveObject=s,this.rotateObjectY=d,this.rotateObjectX=c,this.addHorse=i,this.stop=p,this.play=E,this.addFlamingo=r,this.addScenario=o,this.removeObject=e;var g,v,w,H,_,T,R,M,b,L=(new THREE.Clock,Date.now()),j=!1}var EventListener=klass(function(n){this._eventListeners=[]}).methods({on:function(n,e){this._eventListeners[n]=this._eventListeners[n]||[],this._eventListeners[n].push(e)},off:function(n,e){var t=this._eventListeners[n];t&&t.pop(e)},trigger:function(n,e){for(var t=this._eventListeners[n]||[],o=0;o<t.length;o++){var i=t[o];i.apply(this,e)}}}),FrameProcessor=klass(function(n){this._frame=n.frame,_self=this}).methods({getHandsCount:function(){return this._frame.hands.length},getFingersCount:function(){return _.reduce(this._frame.hands,function(n,e){return n+e.fingers.length},0)},getExtendedFingersCount:function(){return _.reduce(this._frame.hands,function(n,e){return n+_.filter(e.fingers,function(n){return n.extended}).length},0)},getLeftHand:function(){return _.findWhere(this._frame.hands,{type:"left"})},getRightHand:function(){return _.findWhere(this._frame.hands,{type:"right"})},getScreenPosition:function(n){var e=n.screenPosition(),t=c(e[0],window.innerWidth,5),o=c(-1*e[1],window.innerHeight),i=e[2];return new HandPosition(t,o,i)},getFrameRate:function(){return this._frame.currentFrameRate}});TIMEOUT=30;var LeapListener=EventListener.extend(function(n){this._controller=void 0,this._connectTimeout=void 0,_this=this}).methods({_onConnect:function(){clearTimeout(_this._connectTimeout),console.log("Leap Motion connected."),_this.trigger("connected",[])},_onFrame:function(n){_this.trigger("data",[new FrameProcessor({frame:n})])},_onHandFound:function(n){_this.trigger("handFound",[n,n.type])},_onHandLost:function(n){_this.trigger("handLost",[n,n.type])},_connectEvents:function(){this._controller.on("frame",this._onFrame),this._controller.on("handFound",this._onHandFound),this._controller.on("handLost",this._onHandLost)},setup:function(n){console.log("Setting up Leap Motion controller..."),this._controller=new Leap.Controller(n),this._controller.use("screenPosition"),this._controller.use("handEntry"),this._connectEvents()},start:function(){if(void 0===this._controller)throw new SetupException("You need to call setup before start.");console.log("Starting connection with Leap Motion..."),this.trigger("connecting",[]),this._controller.connect(),this._connectTImeout=setTimeout(function(){_this.trigger("connectionTimedout",[]),console.log("Leap Motion connection timed out.")},1e3*TIMEOUT)},stop:function(){if(void 0===this._controller)throw new SetupException("You need to call setup before stop.");console.log("Finishing Leap Motion connection..."),this._controller.disconnect()}});!function(n){var e;n.fn.start=function(){e=new MarionetteDrawer,e.init(this.context.getElementById("container")),e.addScenario(),e.animate()},n.fn.stop=function(){e.stop()},n.fn.play=function(){e.play()},n.fn.removeObject=function(n){e.removeObject(n)},n.fn.addObject=function(n,t){"horse"==t?e.addHorse(n):"flamingo"==t?e.addFlamingo(n):e.addCube(n)},n.fn.moveObject=function(n,t,o,i){e.moveObject(n,t,o,i)},n.fn.rotateObjectX=function(n,t){e.rotateObjectX(n,t)},n.fn.rotateObjectY=function(n,t){e.rotateObjectY(n,t)},n.fn.moveLeftHand=function(n,e,t,o){},n.fn.moveRightHand=function(n,e,t,o){},n.fn.moveLeftLeg=function(n,e,t,o){},n.fn.moveRightLeg=function(n,e,t,o){},n.fn.addObjects=function(){n("container").addObject("a","horse"),n("container").addObject("b","flamingo")},n.fn.organize=function(){n("container").moveObject("b",-200,250,0)}}(jQuery),$(document).ready(function(){$("#container").start();var n=new LeapListener;n.on("connecting",function(){}),n.on("connected",function(){}),n.on("connectionTimedout",function(){}),n.on("pause",function(){}),n.on("resume",function(){}),n.on("data",function(n){if(void 0!=n){var e=n.getLeftHand(),t=n.getRightHand();if(e){console.log("Left hand moving...");var o=n.getScreenPosition(e);$("#container").moveObject("left",o.x,o.y,o.z)}if(t){console.log("Right hand moving...");var o=n.getScreenPosition(t);$("#container").moveObject("right",o.x,o.y,o.z)}}}),n.on("handFound",function(n,e){console.log("%s hand found.",e);var t="left"===e?"horse":"flamingo";$("#container").addObject(e,t)}),n.on("handLost",function(n,e){console.log("%s hand lost.",e),$("#container").removeObject(e)}),n.setup(),n.start()});