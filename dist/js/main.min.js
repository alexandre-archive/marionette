function MarionetteDrawer(){function e(e){w=e,R={},M={},m=new THREE.Scene,T=window.innerWidth,y=window.innerHeight;var t=75,n=T/y,r=.1,o=1e3;g=new THREE.PerspectiveCamera(t,n,r,o),m.add(g),g.position.y=0,g.position.x=0,g.position.z=400,g.target=new THREE.Vector3(0,150,0),g.lookAt(m.position),H=new THREE.WebGLRenderer({antialias:!0}),H.setClearColor(15790320),H.setPixelRatio(window.devicePixelRatio),H.setSize(T,y),w.appendChild(H.domElement);var i=new THREE.DirectionalLight(15724543,2);i.position.set(1,1,1).normalize(),m.add(i);var i=new THREE.DirectionalLight(16773103,2);i.position.set(-1,-1,-1).normalize(),m.add(i),h(),window.addEventListener("resize",p,!1)}function t(e){if(e in R){var t=R[e];m.remove(t)}}function n(e){var t=[];t.push(new THREE.MeshBasicMaterial({color:16724787})),t.push(new THREE.MeshBasicMaterial({color:16746496})),t.push(new THREE.MeshBasicMaterial({color:16777011})),t.push(new THREE.MeshBasicMaterial({color:3407667})),t.push(new THREE.MeshBasicMaterial({color:3355647})),t.push(new THREE.MeshBasicMaterial({color:8926207}));var n=new THREE.MeshFaceMaterial(t),r=new THREE.CubeGeometry(100,100,100,1,1,1);cube=new THREE.Mesh(r,n),cube.position.set(0,0,0),m.add(cube),R[e]=cube}function r(){var e=new THREE.ImageUtils.loadTexture("images/country.png"),t=new THREE.MeshBasicMaterial({map:e,side:THREE.DoubleSide}),n=new THREE.PlaneGeometry(2*T,2*y,10,10),r=new THREE.Mesh(n,t);r.position.z=-400,m.add(r)}function o(e){var t=new THREE.JSONLoader(!0);t.load("models//horse.json",function(t){var n=new THREE.Mesh(t,new THREE.MeshLambertMaterial({color:6316128,morphTargets:!0}));n.scale.set(.8,.8,.8),m.add(n),R[e]=n;var r=new THREE.MorphAnimation(n);r.play(),M[e]=r})}function i(e){var t=new THREE.JSONLoader;t.load("models/flamingo.json",function(t){a(t),t.computeMorphNormals();var n=new THREE.MeshLambertMaterial({color:16777215,morphTargets:!0,morphNormals:!0,vertexColors:THREE.FaceColors,shading:THREE.FlatShading}),r=new THREE.MorphAnimMesh(t,n);r.duration=5e3,r.scale.set(1,1,1),r.position.y=200,m.add(r),R[e]=r,M[e]=r,r.position.setY(240)})}function a(e){if(e.morphColors&&e.morphColors.length)for(var t=e.morphColors[0],n=0;n<t.colors.length;n++)e.faces[n].color=t.colors[n],e.faces[n].color.offsetHSL(0,.3,0)}function s(e,t,n,r){if(e in R){var o=R[e];o.position.setX(t),o.position.setY(n),o.position.setZ(r)}}function c(e,t,n,r){if(e in R){var o=R[e];o.rotation.x=d(t),o.rotation.y=d(n),o.rotation.z=d(r)}}function d(e){return e*Math.PI/180}function u(){requestAnimationFrame(u),l(),v.update()}function l(){if(M&&!C){var e=Date.now();for(obj in M)M[obj].update?M[obj].update(e-b):M[obj].updateAnimation(e-b);b=e}H.clear(),H.setViewport(0,0,T,y),H.render(m,g)}function h(){return v=new Stats,v.setMode(0),v.domElement.style.position="absolute",v.domElement.style.left="0px",v.domElement.style.top="0px",w.appendChild(v.domElement),v}function p(e){T=window.innerWidth,y=window.innerHeight,H.setSize(T,y),g.aspect=.5*T/y,g.updateProjectionMatrix()}function f(){C=!0}function E(){C=!1}this.init=e,this.addCube=n,this.animate=u,this.moveObject=s,this.rotateObject=c,this.addHorse=o,this.stop=f,this.play=E,this.addFlamingo=i,this.addScenario=r,this.removeObject=t;var w,m,g,H,v,R,M,T,y,b=(new THREE.Clock,Date.now()),C=!1}function moveObject(e){if(e&&e.timeVisible>.25&&e.confidence>.7){var t=e.pitchDegree(),n=e.rollDegree(),r=e.yawDegree(),o=e.get3JsScreenPosition();drawer.moveObject(e.type,o.x,o.y,o.z),drawer.rotateObject(e.type,-1*t,r,n)}}Leap.Controller.plugin("leapExtras",function(){function e(e){return e*(180/Math.PI)}return{frame:{getHandsCount:function(){return this.hands.length},getFingersCount:function(){return _.reduce(this.hands,function(e,t){return e+t.fingers.length},0)},getExtendedFingersCount:function(){return _.reduce(this.hands,function(e,t){return e+_.filter(t.fingers,function(e){return e.extended}).length},0)},getLeftHand:function(){return _.findWhere(this.hands,{type:"left"})},getRightHand:function(){return _.findWhere(this.hands,{type:"right"})},getFrameRate:function(){return this.currentFrameRate}},hand:{pitchDegree:function(){return e(this.pitch())},rollDegree:function(){return e(this.roll())},yawDegree:function(){return e(this.yaw())}}}}),Leap.Controller.plugin("threejsPosition",function(){var e,t;return e=function(e,t,n){var r=t,o=0,i=t/(n||2),a=t/-(n||2),s=r-o,c=i-a;return(e-o)*c/s+a},convertDegree=function(e){var t=180,n=-80,r=360,o=0,i=t-n,a=r-o;return(e-n)*a/i+o},t=function(e,t,n){this.x=e,this.y=t,this.z=n},{hand:{get3JsScreenPosition:function(){var n=this.screenPosition(),r=window.innerWidth,o=window.innerHeight,i=e(n[0],r,5),a=e(-1*n[1],o),s=n[2];return new t(i,a,s)},get3JsPitchDegree:function(){return convertDegree(this.pitchDegree())},get3JsRollDegree:function(){return convertDegree(this.rollDegree())}}}});var drawer;$(document).ready(function(){drawer=new MarionetteDrawer,drawer.init(document.getElementById("container")),drawer.addScenario(),drawer.animate();var e=new Leap.Controller;e.use("screenPosition").use("handEntry").use("threejsPosition").use("leapExtras"),e.on("frame",function(e){moveObject(e.getLeftHand()),moveObject(e.getRightHand())}),e.on("handFound",function(e){"left"===e.type?drawer.addHorse(e.type):"right"==e.type?drawer.addFlamingo(e.type):drawer.addCube(e.type),drawer.moveObject(e.type)}),e.on("handLost",function(e){drawer.removeObject(e.type)}),e.connect()});